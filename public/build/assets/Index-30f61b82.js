import{r as _,o as se,j as te,w as R,e as n,b as r,d,Z as oe,f as e,y as f,a6 as V,Y as B,c as u,i as A,a7 as P,t as v,a8 as G,g as C,F as D,m as F,n as K,p as ie,q as ne}from"./app-f994730f.js";import{A as re}from"./LayoutSuperadmi-4dc1cd2d.js";import{a as b,s as g}from"./index.esm-0e4f3215.js";import{b as de}from"./TopMenu-f2fc4239.js";import{_ as ue}from"./_plugin-vue_export-helper-c27b6911.js";import"./ResponsiveNavLink-eb2fad28.js";const t=I=>(ie("data-v-b74755e1"),I=I(),ne(),I),ce={class:"p-4",style:{background:"white"}},ve=t(()=>e("div",{class:"text-center mb-4"},[e("h1",{class:"text-xl font-bold"},"NOTIFICACIONES")],-1)),_e={class:"grid md:grid-cols-3 gap-2 mb-3"},pe=t(()=>e("label",{class:"lbl"},"Rol",-1)),me=t(()=>e("option",{value:""},"— Todos —",-1)),fe=t(()=>e("option",{value:1},"Administradores",-1)),ge=t(()=>e("option",{value:4},"Docentes",-1)),he=t(()=>e("option",{value:5},"Estudiantes",-1)),be=[me,fe,ge,he],ye=t(()=>e("label",{class:"lbl"},"Término",-1)),xe={class:"flex items-end"},we={key:0,class:"text-sm text-blue-600"},Ee={class:"card mb-5"},ke=t(()=>e("div",{class:"font-semibold mb-2"},"Crear notificación",-1)),Ve={class:"grid md:grid-cols-4 gap-2"},Ce={class:"md:col-span-2"},Ue=t(()=>e("label",{class:"lbl"},"Título",-1)),je=t(()=>e("label",{class:"lbl"},"Tipo",-1)),Se=t(()=>e("option",{value:"info"},"info",-1)),Ae=t(()=>e("option",{value:"success"},"success",-1)),Ie=t(()=>e("option",{value:"warning"},"warning",-1)),Le=t(()=>e("option",{value:"error"},"error",-1)),Ne=[Se,Ae,Ie,Le],Te=t(()=>e("label",{class:"lbl"},"Enlace (URL)",-1)),ze={class:"md:col-span-4"},Re=t(()=>e("label",{class:"lbl"},"Mensaje",-1)),De={class:"md:col-span-2"},Fe=t(()=>e("label",{class:"lbl"},"Imagen URL (reutilizar existente)",-1)),Oe={class:"md:col-span-2"},$e=t(()=>e("label",{class:"lbl"},"O subir nueva (png/jpg/jpeg)",-1)),Me={class:"md:col-span-4 flex items-end gap-2"},Be=["src"],Pe={key:1,class:"text-gray-500 text-sm"},Ge={key:2,class:"text-gray-500 text-sm"},Ke={class:"mt-4"},qe=t(()=>e("div",{class:"font-semibold mb-2"},"Destinatarios",-1)),Je={class:"flex items-center gap-3 mb-3"},He={class:"flex items-center gap-2"},Qe={class:"flex items-center gap-2"},Ye={key:0},Ze={class:"grid md:grid-cols-3 gap-2 mb-3"},We=t(()=>e("label",{class:"lbl"},"Rol *",-1)),Xe=t(()=>e("option",{value:""},"— Seleccione —",-1)),el=t(()=>e("option",{value:1},"Administradores",-1)),ll=t(()=>e("option",{value:4},"Docentes",-1)),al=t(()=>e("option",{value:5},"Estudiantes",-1)),sl=[Xe,el,ll,al],tl=t(()=>e("label",{class:"lbl"},"Término (opcional)",-1)),ol={class:"flex items-end"},il={class:"text-sm text-gray-600"},nl={key:1},rl={class:"grid md:grid-cols-3 gap-2 mb-3"},dl=t(()=>e("label",{class:"lbl"},"Rol *",-1)),ul=t(()=>e("option",{value:""},"— Seleccione —",-1)),cl=t(()=>e("option",{value:1},"Administradores",-1)),vl=t(()=>e("option",{value:4},"Docentes",-1)),_l=t(()=>e("option",{value:5},"Estudiantes",-1)),pl=[ul,cl,vl,_l],ml=t(()=>e("label",{class:"lbl"},"Buscar",-1)),fl={class:"flex items-end"},gl={class:"text-sm text-gray-600"},hl={class:"grid md:grid-cols-2 gap-2"},bl=t(()=>e("div",{class:"subt"},"Coincidencias",-1)),yl={class:"list"},xl={class:"text-gray-500"},wl={key:0,class:"text-sm text-gray-500 p-2"},El={class:"subt"},kl={class:"list"},Vl={class:"text-gray-500"},Cl={key:0,class:"text-sm text-gray-500 p-2"},Ul={class:"flex items-center gap-2 mt-4"},jl=t(()=>e("span",{class:"text-xs text-gray-500"},[C("Se marcarán como "),e("strong",null,"no leídas"),C(" y "),e("strong",null,"activas"),C(".")],-1)),Sl={style:{"border-radius":"4px",width:"100%",overflow:"hidden"}},Al=t(()=>e("thead",{style:{height:"30px",color:"#fff","background-color":"var(--primary-color)"}},[e("tr",{style:{"font-size":".9rem"}},[e("th",{class:"th"},"TÍTULO"),e("th",{class:"th"},"MENSAJE"),e("th",{class:"th"},"TIPO"),e("th",{class:"th"},"ENLACE"),e("th",{class:"th"},"IMAGEN"),e("th",{class:"th"},"ESTADO"),e("th",{class:"th"},"USUARIO"),e("th",{class:"th"},"ROL"),e("th",{class:"th"},"FECHA"),e("th",{class:"th",style:{width:"140px"}},"ACCIONES")])],-1)),Il={class:"td"},Ll={class:"td"},Nl={class:"td",style:{"text-align":"center"}},Tl=["href"],zl={key:1},Rl={class:"td",style:{"text-align":"center"}},Dl=["src"],Fl={key:1},Ol={class:"td"},$l={class:"td",style:{"text-align":"center"}},Ml={class:"td",style:{"text-align":"center"}},Bl={class:"td",style:{"text-align":"center"}},Pl={class:"flex items-center gap-2 justify-center"},Gl={key:0},Kl=t(()=>e("td",{class:"td",colspan:"10",style:{"text-align":"center",padding:"10px"}},"Sin resultados",-1)),ql=[Kl],Jl={class:"grid md:grid-cols-4 gap-3"},Hl={class:"md:col-span-2"},Ql=t(()=>e("label",{class:"lbl"},"Título",-1)),Yl=t(()=>e("label",{class:"lbl"},"Tipo",-1)),Zl=t(()=>e("option",{value:"info"},"info",-1)),Wl=t(()=>e("option",{value:"success"},"success",-1)),Xl=t(()=>e("option",{value:"warning"},"warning",-1)),ea=t(()=>e("option",{value:"error"},"error",-1)),la=[Zl,Wl,Xl,ea],aa=t(()=>e("label",{class:"lbl"},"Enlace (URL)",-1)),sa={class:"md:col-span-4"},ta=t(()=>e("label",{class:"lbl"},"Mensaje",-1)),oa={class:"md:col-span-2"},ia=t(()=>e("label",{class:"lbl"},"Imagen URL (reutilizar)",-1)),na={class:"md:col-span-2"},ra=t(()=>e("label",{class:"lbl"},"O subir nueva",-1)),da={class:"md:col-span-4 flex items-end gap-2"},ua=["src"],ca={key:1,class:"text-gray-500 text-sm"},va={key:2,class:"text-gray-500 text-sm"},_a=t(()=>e("label",{class:"lbl"},"Estado",-1)),pa=t(()=>e("option",{value:1},"Activo",-1)),ma=t(()=>e("option",{value:0},"Inactivo",-1)),fa=[pa,ma],ga=t(()=>e("label",{class:"lbl"},"Leído",-1)),ha=t(()=>e("option",{value:0},"No leído",-1)),ba=t(()=>e("option",{value:1},"Leído",-1)),ya=[ha,ba],xa={class:"flex items-center gap-2"},wa={__name:"Index",setup(I){const o=_(!1),x=_({rol_id:"",term:""}),L=_([]),c=_({titulo:"",mensaje:"",tipo:"info",url:"",imagen_url:""}),w=_("filtros"),N=_(null),T=_(null),y=_({crear:"",editar:""}),p=_({rol_id:"",term:""}),z=_(0),E=_({rol_id:"",term:""}),j=_([]),h=_([]),S=_(!1),i=_({id:null,titulo:"",mensaje:"",tipo:"info",url:"",imagen_url:"",activo:1,leido:0}),O=s=>s===!0||s===1||s==="1"?"Activo":s===!1||s===0||s==="0"?"Inactivo":String(s??"—"),q=s=>O(s)==="Activo"?"ok":"bad",J=s=>{if(!s)return"";const l=String(s).toLowerCase();return l==="success"?"success":l==="warning"||l==="warn"?"warn":l==="error"||l==="danger"?"error":"info"},H=s=>s?new Date(s).toLocaleString():"—";function Q(){x.value={rol_id:"",term:""},k()}async function k(){var s;if(!o.value){o.value=!0;try{const l={rol_id:x.value.rol_id||void 0,term:x.value.term||void 0,per_page:50},{data:a}=await axios.post("/superadmi/listar-notificaciones",l);L.value=Array.isArray((s=a==null?void 0:a.datos)==null?void 0:s.data)?a.datos.data:[]}catch(l){console.error("Error al cargar notificaciones:",l),alert("Error al cargar notificaciones."),L.value=[]}finally{o.value=!1}}}async function Y(){if(!p.value.rol_id){alert("Seleccione un rol para estimar destinatarios");return}if(!o.value){o.value=!0;try{const s={rol_id:p.value.rol_id,term:p.value.term||void 0,limite:50},{data:l}=await axios.post("/superadmi/buscar-usuarios-notificaciones",s);z.value=Array.isArray(l==null?void 0:l.datos)?l.datos.length:0}catch(s){console.error("Error al validar filtros:",s),alert("Error al estimar destinatarios."),z.value=0}finally{o.value=!1}}}async function $(){if(!E.value.rol_id){alert("Seleccione un rol para buscar usuarios");return}if(!o.value){o.value=!0;try{const s={rol_id:E.value.rol_id,term:E.value.term||void 0,limite:50},{data:l}=await axios.post("/superadmi/buscar-usuarios-notificaciones",s);j.value=Array.isArray(l==null?void 0:l.datos)?l.datos:[]}catch(s){console.error("Error al buscar usuarios:",s),alert("Error al buscar usuarios."),j.value=[]}finally{o.value=!1}}}function Z(s){h.value.find(l=>l.id===s.id)||h.value.push(s)}function W(s){h.value=h.value.filter(l=>l.id!==s)}function M(s,l){var U;const a=(U=s.target.files)==null?void 0:U[0];if(!a)return;if(!/image\/(png|jpe?g)/i.test(a.type)){alert("Solo se permiten PNG/JPG/JPEG");return}const m=new FileReader;m.onload=()=>{l==="crear"?(N.value=a,y.value.crear=m.result,c.value.imagen_url=""):(T.value=a,y.value.editar=m.result,i.value.imagen_url="")},m.readAsDataURL(a)}async function X(){var s;if(!((s=c.value.mensaje)!=null&&s.trim())){alert("El mensaje es obligatorio");return}if(!o.value){o.value=!0;try{const l=new FormData;if(l.append("titulo",c.value.titulo||""),l.append("mensaje",c.value.mensaje||""),l.append("tipo",c.value.tipo||"info"),l.append("url",c.value.url||""),l.append("activo","1"),c.value.imagen_url&&l.append("imagen_url",c.value.imagen_url),N.value&&l.append("imagen_file",N.value),w.value==="usuarios"){const m=h.value.map(U=>U.id);if(m.length===0){alert("Seleccione al menos un usuario");return}m.forEach(U=>l.append("user_ids[]",U))}else{if(!p.value.rol_id){alert("Seleccione un rol para los destinatarios");return}l.append("rol_id",p.value.rol_id),p.value.term&&l.append("term",p.value.term)}const{data:a}=await axios.post("/superadmi/guardar-notificacion",l,{headers:{"Content-Type":"multipart/form-data"}});alert(`${(a==null?void 0:a.mensaje)||"Creado"} (creadas: ${(a==null?void 0:a.creadas)??0})`),c.value={titulo:"",mensaje:"",tipo:"info",url:"",imagen_url:""},N.value=null,y.value.crear="",h.value=[],p.value={rol_id:"",term:""},z.value=0,await k()}catch(l){console.error("Error al crear notificación:",l),alert("Error al crear notificación.")}finally{o.value=!1}}}function ee(s){i.value={id:s.id,titulo:s.titulo||"",mensaje:s.mensaje||"",tipo:s.tipo||"info",url:s.url||"",imagen_url:s.imagen_url||"",activo:s.activo?1:0,leido:s.leido?1:0},T.value=null,y.value.editar="",S.value=!0}async function le(){const s=i.value.id;if(s&&!o.value){o.value=!0;try{const l=new FormData;l.append("titulo",i.value.titulo||""),l.append("mensaje",i.value.mensaje||""),l.append("tipo",i.value.tipo||"info"),l.append("url",i.value.url||""),l.append("activo",String(i.value.activo?1:0)),l.append("leido",String(i.value.leido?1:0)),i.value.imagen_url&&l.append("imagen_url",i.value.imagen_url),T.value&&l.append("imagen_file",T.value);const{data:a}=await axios.post(`/superadmi/actualizar-notificacion/${s}`,l,{headers:{"Content-Type":"multipart/form-data"}});alert((a==null?void 0:a.mensaje)||"Actualizado"),S.value=!1,await k()}catch(l){console.error("Error al actualizar notificación:",l),alert("Error al actualizar notificación.")}finally{o.value=!1}}}async function ae(s){if(confirm("¿Eliminar esta notificación?")&&!o.value){o.value=!0;try{const{data:l}=await axios.post(`/superadmi/eliminar-notificacion/${s.id}`);alert((l==null?void 0:l.mensaje)||"Eliminado"),await k()}catch(l){console.error("Error al eliminar notificación:",l),alert("Error al eliminar notificación.")}finally{o.value=!1}}}return se(()=>{k()}),(s,l)=>(n(),te(re,null,{default:R(()=>[r(d(oe),{title:"Notificaciones"}),e("div",ce,[ve,e("div",_e,[e("div",null,[pe,f(e("select",{"onUpdate:modelValue":l[0]||(l[0]=a=>x.value.rol_id=a),class:"inp"},be,512),[[V,x.value.rol_id]])]),e("div",null,[ye,r(d(b),{modelValue:x.value.term,"onUpdate:modelValue":l[1]||(l[1]=a=>x.value.term=a),class:"w-full",placeholder:"Título, mensaje, usuario, DNI, código…",onKeyup:B(k,["enter"])},null,8,["modelValue","onKeyup"])]),e("div",xe,[r(d(g),{label:"Buscar",size:"small",onClick:k,disabled:o.value},null,8,["disabled"]),r(d(g),{label:"Limpiar",size:"small",severity:"secondary",onClick:Q,disabled:o.value},null,8,["disabled"])])]),o.value?(n(),u("span",we,"Cargando...")):A("",!0),e("div",Ee,[ke,e("div",Ve,[e("div",Ce,[Ue,r(d(b),{modelValue:c.value.titulo,"onUpdate:modelValue":l[2]||(l[2]=a=>c.value.titulo=a),class:"w-full",placeholder:"Opcional"},null,8,["modelValue"])]),e("div",null,[je,f(e("select",{"onUpdate:modelValue":l[3]||(l[3]=a=>c.value.tipo=a),class:"inp"},Ne,512),[[V,c.value.tipo]])]),e("div",null,[Te,r(d(b),{modelValue:c.value.url,"onUpdate:modelValue":l[4]||(l[4]=a=>c.value.url=a),class:"w-full",placeholder:"https://…"},null,8,["modelValue"])]),e("div",ze,[Re,f(e("textarea",{"onUpdate:modelValue":l[5]||(l[5]=a=>c.value.mensaje=a),class:"inp w-full",rows:"3",placeholder:"Mensaje a mostrar"},null,512),[[P,c.value.mensaje]])]),e("div",De,[Fe,r(d(b),{modelValue:c.value.imagen_url,"onUpdate:modelValue":l[6]||(l[6]=a=>c.value.imagen_url=a),class:"w-full",placeholder:"Pegar URL de imagen previa (ej. /storage/notificaciones/abc.jpg)"},null,8,["modelValue"])]),e("div",Oe,[$e,e("input",{type:"file",accept:".png,.jpg,.jpeg",onChange:l[7]||(l[7]=a=>M(a,"crear"))},null,32)]),e("div",Me,[y.value.crear?(n(),u("img",{key:0,src:y.value.crear,alt:"prev",class:"h-16 rounded object-contain border"},null,8,Be)):c.value.imagen_url?(n(),u("span",Pe,"URL: "+v(c.value.imagen_url),1)):(n(),u("span",Ge,"Sin imagen"))])]),e("div",Ke,[qe,e("div",Je,[e("label",He,[f(e("input",{type:"radio",value:"filtros","onUpdate:modelValue":l[8]||(l[8]=a=>w.value=a)},null,512),[[G,w.value]]),C(" Usar filtros ")]),e("label",Qe,[f(e("input",{type:"radio",value:"usuarios","onUpdate:modelValue":l[9]||(l[9]=a=>w.value=a)},null,512),[[G,w.value]]),C(" Seleccionar usuarios ")])]),w.value==="filtros"?(n(),u("div",Ye,[e("div",Ze,[e("div",null,[We,f(e("select",{"onUpdate:modelValue":l[10]||(l[10]=a=>p.value.rol_id=a),class:"inp"},sl,512),[[V,p.value.rol_id]])]),e("div",null,[tl,r(d(b),{modelValue:p.value.term,"onUpdate:modelValue":l[11]||(l[11]=a=>p.value.term=a),class:"w-full",placeholder:"Nombre, apellido, DNI, código, email"},null,8,["modelValue"])]),e("div",ol,[r(d(g),{label:"Estimar",size:"small",onClick:Y,disabled:o.value},null,8,["disabled"]),e("span",il,"Estimados: "+v(z.value),1)])])])):w.value==="usuarios"?(n(),u("div",nl,[e("div",rl,[e("div",null,[dl,f(e("select",{"onUpdate:modelValue":l[12]||(l[12]=a=>E.value.rol_id=a),class:"inp"},pl,512),[[V,E.value.rol_id]])]),e("div",null,[ml,r(d(b),{modelValue:E.value.term,"onUpdate:modelValue":l[13]||(l[13]=a=>E.value.term=a),class:"w-full",placeholder:"Nombre, apellido, DNI, código, email",onKeyup:B($,["enter"])},null,8,["modelValue","onKeyup"])]),e("div",fl,[r(d(g),{label:"Buscar",size:"small",onClick:$,disabled:o.value},null,8,["disabled"]),e("span",gl,"Resultados: "+v(j.value.length),1)])]),e("div",hl,[e("div",null,[bl,e("div",yl,[(n(!0),u(D,null,F(j.value,a=>(n(),u("div",{key:a.id,class:"row"},[e("span",null,[C(v(a.nombre_completo)+" ",1),e("small",xl,"("+v(a.rol_nombre)+")",1)]),r(d(g),{label:"Agregar",size:"small",onClick:m=>Z(a)},null,8,["onClick"])]))),128)),j.value.length===0?(n(),u("div",wl,"Sin resultados")):A("",!0)])]),e("div",null,[e("div",El,"Seleccionados ("+v(h.value.length)+")",1),e("div",kl,[(n(!0),u(D,null,F(h.value,a=>(n(),u("div",{key:a.id,class:"row"},[e("span",null,[C(v(a.nombre_completo)+" ",1),e("small",Vl,"("+v(a.rol_nombre)+")",1)]),r(d(g),{label:"Quitar",size:"small",severity:"secondary",onClick:m=>W(a.id)},null,8,["onClick"])]))),128)),h.value.length===0?(n(),u("div",Cl,"Ninguno")):A("",!0)])])])])):A("",!0)]),e("div",Ul,[r(d(g),{label:"Crear notificación",onClick:X,disabled:o.value},null,8,["disabled"]),jl])]),e("table",Sl,[Al,e("tbody",null,[(n(!0),u(D,null,F(L.value,a=>(n(),u("tr",{key:a.id,style:{"font-size":".9rem"}},[e("td",Il,v(a.titulo||"—"),1),e("td",Ll,[e("strong",null,v(a.mensaje),1)]),e("td",{class:K(["td",J(a.tipo)]),style:{"text-align":"center"}},v(a.tipo),3),e("td",Nl,[a.url?(n(),u("a",{key:0,href:a.url,target:"_blank",class:"underline text-blue-600"},"Ir al enlace",8,Tl)):(n(),u("span",zl,"—"))]),e("td",Rl,[a.imagen_url?(n(),u("img",{key:0,src:a.imagen_url,alt:"img",style:{"max-height":"40px","object-fit":"contain",margin:"auto"}},null,8,Dl)):(n(),u("span",Fl,"—"))]),e("td",{class:K(["td",q(a.activo)]),style:{"text-align":"center"}},v(O(a.activo)),3),e("td",Ol,v(a.usuario||"—"),1),e("td",$l,v(a.rol_nombre),1),e("td",Ml,v(H(a.created_at)),1),e("td",Bl,[e("div",Pl,[r(d(g),{label:"Editar",size:"small",onClick:m=>ee(a),disabled:o.value},null,8,["onClick","disabled"]),r(d(g),{label:"Eliminar",size:"small",severity:"danger",onClick:m=>ae(a),disabled:o.value},null,8,["onClick","disabled"])])])]))),128)),L.value.length===0&&!o.value?(n(),u("tr",Gl,ql)):A("",!0)])])]),r(d(de),{visible:S.value,"onUpdate:visible":l[23]||(l[23]=a=>S.value=a),modal:"",header:"Editar notificación",style:{width:"640px"}},{footer:R(()=>[e("div",xa,[r(d(g),{label:"Guardar cambios",onClick:le,disabled:o.value},null,8,["disabled"]),r(d(g),{label:"Cerrar",severity:"secondary",onClick:l[22]||(l[22]=a=>S.value=!1)})])]),default:R(()=>[e("div",Jl,[e("div",Hl,[Ql,r(d(b),{modelValue:i.value.titulo,"onUpdate:modelValue":l[14]||(l[14]=a=>i.value.titulo=a),class:"w-full"},null,8,["modelValue"])]),e("div",null,[Yl,f(e("select",{"onUpdate:modelValue":l[15]||(l[15]=a=>i.value.tipo=a),class:"inp"},la,512),[[V,i.value.tipo]])]),e("div",null,[aa,r(d(b),{modelValue:i.value.url,"onUpdate:modelValue":l[16]||(l[16]=a=>i.value.url=a),class:"w-full"},null,8,["modelValue"])]),e("div",sa,[ta,f(e("textarea",{"onUpdate:modelValue":l[17]||(l[17]=a=>i.value.mensaje=a),class:"inp w-full",rows:"3"},null,512),[[P,i.value.mensaje]])]),e("div",oa,[ia,r(d(b),{modelValue:i.value.imagen_url,"onUpdate:modelValue":l[18]||(l[18]=a=>i.value.imagen_url=a),class:"w-full",placeholder:"Pegar URL de imagen previa"},null,8,["modelValue"])]),e("div",na,[ra,e("input",{type:"file",accept:".png,.jpg,.jpeg",onChange:l[19]||(l[19]=a=>M(a,"editar"))},null,32)]),e("div",da,[y.value.editar?(n(),u("img",{key:0,src:y.value.editar,class:"h-16 rounded object-contain border"},null,8,ua)):i.value.imagen_url?(n(),u("span",ca,"URL: "+v(i.value.imagen_url),1)):(n(),u("span",va,"Sin imagen"))]),e("div",null,[_a,f(e("select",{"onUpdate:modelValue":l[20]||(l[20]=a=>i.value.activo=a),class:"inp"},fa,512),[[V,i.value.activo]])]),e("div",null,[ga,f(e("select",{"onUpdate:modelValue":l[21]||(l[21]=a=>i.value.leido=a),class:"inp"},ya,512),[[V,i.value.leido]])])])]),_:1},8,["visible"])]),_:1}))}},Sa=ue(wa,[["__scopeId","data-v-b74755e1"]]);export{Sa as default};
