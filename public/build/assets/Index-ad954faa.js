import{u as Z,k as J,r as p,G as Q,o as W,j as X,w as n,a as F,e as w,b as s,d as o,Z as Y,f as i,c as V,t as c,i as $,g,p as ee,q as ae}from"./app-df00ec4e.js";import{A as te}from"./LayoutSupervisor-adc8305f.js";import{a as oe,s as h}from"./index.esm-b50760ad.js";import{s as se}from"./dropdown.esm-b8162aa9.js";import{s as R}from"./inputswitch.esm-9fffc8a1.js";import{s as le,a as ie,b as ne}from"./TopMenu-edcbe2b9.js";import{s as T}from"./calendar.esm-f2e9caa2.js";import{s as re}from"./confirmdialog.esm-d6ce107e.js";import{s as de}from"./datatable.esm-71078f41.js";import{s as m}from"./column.esm-434bfdc1.js";import{s as ce}from"./toolbar.esm-a9efb829.js";import{s as ue}from"./card.esm-d1306a8c.js";import{s as pe}from"./divider.esm-c56bad51.js";import{_ as me}from"./_plugin-vue_export-helper-c27b6911.js";import"./ResponsiveNavLink-fc04ebc9.js";import"./index.esm-eeb2d688.js";import"./inputnumber.esm-fe2002eb.js";import"./basecomponent.esm-f06aea8c.js";const b=x=>(ee("data-v-ba9873a4"),x=x(),ae(),x),fe={class:"p-4"},ve=b(()=>i("h1",{class:"text-xl font-bold"},"Panel de Control de Módulos",-1)),_e={class:"flex items-center gap-2 flex-wrap"},ge={key:0,class:"flex items-center gap-2"},he={class:"text-sm font-semibold"},be={class:"text-xs"},ye=b(()=>i("strong",null,"Inicio:",-1)),we={class:"text-xs"},xe=b(()=>i("strong",null,"Fin:",-1)),Ve=b(()=>i("div",{class:"text-center p-4"},"No se encontraron reglas con los filtros actuales.",-1)),$e={key:0,class:"flex flex-col gap-4 p-4"},Ce={key:0},ke={key:1},De=b(()=>i("label",{class:"block text-sm font-medium mb-1"},"Fecha de Inicio",-1)),Ee=b(()=>i("label",{class:"block text-sm font-medium mb-1"},"Fecha de Fin",-1)),Ae={class:"flex items-center gap-2 mt-2"},Ie={class:"font-medium"},Me={__name:"Index",setup(x){const C=Z(),U=J();let A=null;const r=p({data:[],total:0,per_page:10,current_page:1,last_page:1}),f=p({q:"",modulo:null,id_escuela:null}),v=p(!1),u=p([]),y=p(!1),l=p(null),z=p([{label:"Resolucion",value:"Resolucion"},{label:"Plan",value:"Plan"},{label:"Informe",value:"Informe"},{label:"Dictantes",value:"Dictantes"},{label:"Otros",value:"Otros"}]),N=Q(()=>(r.value.current_page-1)*r.value.per_page),_=async(t=1)=>{v.value=!0;try{const a={...f.value,page:t,per_page:r.value.per_page};console.log("Enviando parámetros:",a);const e=await F.post("get-controles",a);console.log("Respuesta recibida:",e.data),e.data&&e.data.datos?e.data.datos.data?r.value={data:e.data.datos.data,total:e.data.datos.total,per_page:e.data.datos.per_page,current_page:e.data.datos.current_page,last_page:e.data.datos.last_page}:r.value={data:e.data.datos,total:e.data.datos.length,per_page:a.per_page,current_page:t,last_page:Math.ceil(e.data.datos.length/a.per_page)}:e.data&&Array.isArray(e.data.datos)?r.value={data:e.data.datos,total:e.data.datos.length,per_page:a.per_page,current_page:t,last_page:Math.ceil(e.data.datos.length/a.per_page)}:r.value={data:e.data.data||e.data||[],total:e.data.total||(Array.isArray(e.data)?e.data.length:0),per_page:e.data.per_page||a.per_page,current_page:e.data.current_page||t,last_page:e.data.last_page||1},console.log("Reglas procesadas:",r.value)}catch(a){console.error("Error cargando reglas:",a),C.add({severity:"error",summary:"Error de Carga",detail:"No se pudieron cargar las reglas.",life:3e3})}finally{v.value=!1}},P=()=>{f.value={q:"",modulo:null,id_escuela:null},_(1)},L=()=>{clearTimeout(A),A=setTimeout(()=>{_(1)},500)},k=async(t,a)=>{v.value=!0;try{return await F.post("update-controles",t),C.add({severity:"success",summary:"Éxito",detail:a,life:3e3}),_(r.value.current_page),!0}catch(e){return console.error("Error en actualización:",e),C.add({severity:"error",summary:"Error",detail:"La operación falló.",life:3e3}),!1}finally{v.value=!1}},q=async t=>{await k({ids:[t.id],estado:t.estado},"Estado actualizado.")||(t.estado=!t.estado)},B=async()=>{if(!l.value)return;const t={ids:[l.value.id],estado:l.value.estado,fecha_inicio:l.value.fecha_inicio.toISOString().slice(0,19).replace("T"," "),fecha_fin:l.value.fecha_fin.toISOString().slice(0,19).replace("T"," ")};await k(t,"Regla guardada con éxito.")&&(y.value=!1)},I=t=>{if(u.value.length===0)return;const a=u.value.map(e=>e.id);U.require({message:`¿Estás seguro de ${t?"activar":"desactivar"} las ${a.length} reglas seleccionadas?`,header:"Confirmación de Acción Masiva",icon:"pi pi-exclamation-triangle",acceptLabel:"Sí, continuar",rejectLabel:"Cancelar",accept:async()=>{await k({ids:a,estado:t},"Las reglas seleccionadas han sido actualizadas.")&&(u.value=[])}})},O=t=>{const a=t.page+1;console.log("Cambiando a página:",a),_(a)},G=t=>{l.value={...t,fecha_inicio:new Date(t.fecha_inicio),fecha_fin:new Date(t.fecha_fin)},y.value=!0},M=t=>t?new Date(t).toLocaleString("es-PE",{dateStyle:"short",timeStyle:"short"}):"N/A",j=t=>t.estado&&new Date(t.fecha_fin)>new Date?"fila-activa":"fila-inactiva",H=t=>{if(!t.estado)return"Desactivado";const a=new Date,d=new Date(t.fecha_fin)-a;if(d<=0)return"Expirado";const S=Math.floor(d/(1e3*60*60*24)),D=Math.floor(d/(1e3*60*60)%24),E=Math.floor(d/1e3/60%60);return S>0?`~ ${S} d, ${D} h`:D>0?`${D} h, ${E} min`:E>0?`${E} min`:"Menos de un minuto"},K=t=>{if(!t.estado||new Date(t.fecha_fin)<new Date)return"danger";const a=new Date;return(new Date(t.fecha_fin)-a)/(1e3*60*60)<24?"warn":"success"};return W(()=>{_()}),(t,a)=>(w(),X(te,null,{default:n(()=>[s(o(Y),{title:"Panel de Control de Módulos"}),s(o(le)),s(o(re)),i("div",fe,[s(o(ue),null,{title:n(()=>[ve]),content:n(()=>[s(o(ce),{class:"mb-4"},{start:n(()=>[i("div",_e,[s(o(oe),{modelValue:f.value.q,"onUpdate:modelValue":a[0]||(a[0]=e=>f.value.q=e),placeholder:"Buscar por Módulo o Nombre...",onInput:L,class:"w-full sm:w-auto"},null,8,["modelValue"]),s(o(se),{modelValue:f.value.modulo,"onUpdate:modelValue":a[1]||(a[1]=e=>f.value.modulo=e),options:z.value,optionLabel:"label",optionValue:"value",placeholder:"Filtrar Módulo",showClear:"",onChange:a[2]||(a[2]=e=>_(1)),class:"w-full sm:w-auto"},null,8,["modelValue","options"]),s(o(h),{icon:"pi pi-times",severity:"secondary",onClick:P,rounded:""})])]),end:n(()=>[u.value.length>0?(w(),V("div",ge,[i("span",he,c(u.value.length)+" seleccionado(s)",1),s(o(h),{label:"Activar",icon:"pi pi-check",size:"small",severity:"success",onClick:a[3]||(a[3]=e=>I(!0))}),s(o(h),{label:"Desactivar",icon:"pi pi-times",size:"small",severity:"danger",onClick:a[4]||(a[4]=e=>I(!1))})])):$("",!0)]),_:1}),s(o(de),{value:r.value.data,selection:u.value,"onUpdate:selection":a[5]||(a[5]=e=>u.value=e),dataKey:"id",loading:v.value,stripedRows:"",responsiveLayout:"scroll",paginator:"",rows:r.value.per_page,totalRecords:r.value.total,first:o(N),onPage:O,lazy:!0,rowClass:j},{empty:n(()=>[Ve]),default:n(()=>[s(o(m),{selectionMode:"multiple",headerStyle:"width: 3em"}),s(o(m),{field:"modulo",header:"Módulo",sortable:!0,style:{"min-width":"10rem"}}),s(o(m),{field:"nombre_usuario",header:"Usuario",sortable:!0,style:{"min-width":"12rem"}},{body:n(({data:e})=>[g(c(e.nombre_usuario||"N/A (Global o Escuela)"),1)]),_:1}),s(o(m),{header:"Vigencia",style:{"min-width":"12rem"}},{body:n(({data:e})=>[i("div",be,[ye,g(" "+c(M(e.fecha_inicio)),1)]),i("div",we,[xe,g(" "+c(M(e.fecha_fin)),1)])]),_:1}),s(o(m),{header:"Tiempo Restante",style:{"min-width":"10rem"}},{body:n(({data:e})=>[s(o(ie),{severity:K(e),value:H(e)},null,8,["severity","value"])]),_:1}),s(o(m),{header:"Estado",style:{width:"6rem"}},{body:n(({data:e})=>[s(o(R),{modelValue:e.estado,"onUpdate:modelValue":d=>e.estado=d,onChange:d=>q(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),s(o(m),{header:"Acciones",headerStyle:"width: 5em; text-align: center"},{body:n(({data:e})=>[s(o(h),{icon:"pi pi-pencil",class:"p-button-rounded p-button-info",onClick:d=>G(e)},null,8,["onClick"])]),_:1})]),_:1},8,["value","selection","loading","rows","totalRecords","first"])]),_:1})]),s(o(ne),{visible:y.value,"onUpdate:visible":a[10]||(a[10]=e=>y.value=e),modal:"",header:"Editar Regla",style:{width:"30rem"}},{footer:n(()=>[s(o(h),{label:"Cancelar",severity:"secondary",onClick:a[9]||(a[9]=e=>y.value=!1)}),s(o(h),{label:"Guardar Cambios",onClick:B,loading:v.value},null,8,["loading"])]),default:n(()=>[l.value?(w(),V("div",$e,[i("div",null,[g("Módulo: "),i("strong",null,c(l.value.modulo),1)]),l.value.nombre_usuario?(w(),V("div",Ce,[g("Usuario: "),i("strong",null,c(l.value.nombre_usuario),1)])):$("",!0),l.value.id_escuela?(w(),V("div",ke,[g("Escuela ID: "),i("strong",null,c(l.value.id_escuela),1)])):$("",!0),s(o(pe)),i("div",null,[De,s(o(T),{modelValue:l.value.fecha_inicio,"onUpdate:modelValue":a[6]||(a[6]=e=>l.value.fecha_inicio=e),showTime:"",hourFormat:"24",class:"w-full"},null,8,["modelValue"])]),i("div",null,[Ee,s(o(T),{modelValue:l.value.fecha_fin,"onUpdate:modelValue":a[7]||(a[7]=e=>l.value.fecha_fin=e),showTime:"",hourFormat:"24",class:"w-full"},null,8,["modelValue"])]),i("div",Ae,[s(o(R),{modelValue:l.value.estado,"onUpdate:modelValue":a[8]||(a[8]=e=>l.value.estado=e)},null,8,["modelValue"]),i("label",Ie,"Estado "+c(l.value.estado?"Activo":"Inactivo"),1)])])):$("",!0)]),_:1},8,["visible"])]),_:1}))}},Qe=me(Me,[["__scopeId","data-v-ba9873a4"]]);export{Qe as default};
