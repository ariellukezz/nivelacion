import{u as K,k as Z,r as c,o as H,j as J,w as n,a as F,e as g,b as t,d as s,Z as Q,f as i,c as w,t as u,i as x,g as h}from"./app-f994730f.js";import{A as W}from"./LayoutSupervisor-c0bedf40.js";import{a as X,s as _}from"./index.esm-0e4f3215.js";import{s as Y}from"./dropdown.esm-99078355.js";import{s as T}from"./inputswitch.esm-07258200.js";import{s as ee,a as ae,b as oe}from"./TopMenu-f2fc4239.js";import{s as I}from"./calendar.esm-aba2d05d.js";import{s as te}from"./confirmdialog.esm-c88080fc.js";import{s as se}from"./datatable.esm-f7182f59.js";import{s as d}from"./column.esm-434bfdc1.js";import{s as le}from"./toolbar.esm-63709193.js";import{s as ie}from"./card.esm-2b8579c0.js";import{s as ne}from"./divider.esm-52ca8ff3.js";import"./_plugin-vue_export-helper-c27b6911.js";import"./ResponsiveNavLink-eb2fad28.js";import"./index.esm-724f1086.js";import"./inputnumber.esm-8769ed9c.js";import"./basecomponent.esm-b559aace.js";const re={class:"p-4"},ce=i("h1",{class:"text-xl font-bold"},"Panel de Control de Módulos",-1),ue={class:"flex items-center gap-2 flex-wrap"},de={key:0,class:"flex items-center gap-2"},me={class:"text-sm font-semibold"},fe={class:"text-xs"},pe=i("strong",null,"Inicio:",-1),ve={class:"text-xs"},he=i("strong",null,"Fin:",-1),_e=i("div",{class:"text-center p-4"},"No se encontraron reglas con los filtros actuales.",-1),be={key:0,class:"flex flex-col gap-4 p-4"},ge={key:0},ye={key:1},we=i("label",{class:"block text-sm font-medium mb-1"},"Fecha de Inicio",-1),xe=i("label",{class:"block text-sm font-medium mb-1"},"Fecha de Fin",-1),Ve={class:"flex items-center gap-2 mt-2"},$e={class:"font-medium"},je={__name:"Index",setup(Ce){const V=K(),U=Z();let E=null;const y=c({data:[],total:0,per_page:15}),f=c({q:"",modulo:null,id_escuela:null}),$=c(1),p=c(!1),m=c([]),b=c(!1),l=c(null),R=c([{label:"Resolucion",value:"Resolucion"},{label:"Plan",value:"Plan"},{label:"Informe",value:"Informe"},{label:"Dictantes",value:"Dictantes"},{label:"Otros",value:"Otros"}]),v=async(o=1)=>{p.value=!0,$.value=o;try{const a={...f.value,page:$.value},e=await F.post("get-controles",a);y.value=e.data}catch{V.add({severity:"error",summary:"Error de Carga",detail:"No se pudieron cargar las reglas.",life:3e3})}finally{p.value=!1}},N=()=>{f.value={q:"",modulo:null,id_escuela:null},v(1)},L=()=>{clearTimeout(E),E=setTimeout(()=>{v(1)},500)},C=async(o,a)=>{p.value=!0;try{return await F.post("update-controles",o),V.add({severity:"success",summary:"Éxito",detail:a,life:3e3}),v($.value),!0}catch{return V.add({severity:"error",summary:"Error",detail:"La operación falló.",life:3e3}),!1}finally{p.value=!1}},P=async o=>{await C({ids:[o.id],estado:o.estado},"Estado actualizado.")||(o.estado=!o.estado)},z=async()=>{if(!l.value)return;const o={ids:[l.value.id],estado:l.value.estado,fecha_inicio:l.value.fecha_inicio.toISOString().slice(0,19).replace("T"," "),fecha_fin:l.value.fecha_fin.toISOString().slice(0,19).replace("T"," ")};await C(o,"Regla guardada con éxito.")&&(b.value=!1)},M=o=>{if(m.value.length===0)return;const a=m.value.map(e=>e.id);U.require({message:`¿Estás seguro de ${o?"activar":"desactivar"} las ${a.length} reglas seleccionadas?`,header:"Confirmación de Acción Masiva",icon:"pi pi-exclamation-triangle",acceptLabel:"Sí, continuar",rejectLabel:"Cancelar",accept:async()=>{await C({ids:a,estado:o},"Las reglas seleccionadas han sido actualizadas.")&&(m.value=[])}})},q=o=>{v(o.page+1)},B=o=>{l.value={...o,fecha_inicio:new Date(o.fecha_inicio),fecha_fin:new Date(o.fecha_fin)},b.value=!0},A=o=>o?new Date(o).toLocaleString("es-PE",{dateStyle:"short",timeStyle:"short"}):"N/A",O=o=>o.estado&&new Date(o.fecha_fin)>new Date?"fila-activa":"fila-inactiva",j=o=>{if(!o.estado)return"Desactivado";const a=new Date,r=new Date(o.fecha_fin)-a;if(r<=0)return"Expirado";const S=Math.floor(r/(1e3*60*60*24)),k=Math.floor(r/(1e3*60*60)%24),D=Math.floor(r/1e3/60%60);return S>0?`~ ${S} d, ${k} h`:k>0?`${k} h, ${D} min`:D>0?`${D} min`:"Menos de un minuto"},G=o=>!o.estado||new Date(o.fecha_fin)<new Date?"danger":"success";return H(()=>{v()}),(o,a)=>(g(),J(W,null,{default:n(()=>[t(s(Q),{title:"Panel de Control de Módulos"}),t(s(ee)),t(s(te)),i("div",re,[t(s(ie),null,{title:n(()=>[ce]),content:n(()=>[t(s(le),{class:"mb-4"},{start:n(()=>[i("div",ue,[t(s(X),{modelValue:f.value.q,"onUpdate:modelValue":a[0]||(a[0]=e=>f.value.q=e),placeholder:"Buscar por Módulo o Nombre...",onInput:L,class:"w-full sm:w-auto"},null,8,["modelValue"]),t(s(Y),{modelValue:f.value.modulo,"onUpdate:modelValue":a[1]||(a[1]=e=>f.value.modulo=e),options:R.value,optionLabel:"label",optionValue:"value",placeholder:"Filtrar Módulo",showClear:"",onChange:a[2]||(a[2]=e=>v(1)),class:"w-full sm:w-auto"},null,8,["modelValue","options"]),t(s(_),{icon:"pi pi-times",severity:"secondary",onClick:N,rounded:""})])]),end:n(()=>[m.value.length>0?(g(),w("div",de,[i("span",me,u(m.value.length)+" seleccionado(s)",1),t(s(_),{label:"Activar",icon:"pi pi-check",size:"small",severity:"success",onClick:a[3]||(a[3]=e=>M(!0))}),t(s(_),{label:"Desactivar",icon:"pi pi-times",size:"small",severity:"danger",onClick:a[4]||(a[4]=e=>M(!1))})])):x("",!0)]),_:1}),t(s(se),{value:y.value.data,selection:m.value,"onUpdate:selection":a[5]||(a[5]=e=>m.value=e),dataKey:"id",loading:p.value,stripedRows:"",responsiveLayout:"scroll",paginator:"",rows:y.value.per_page,totalRecords:y.value.total,onPage:q,rowClass:O},{empty:n(()=>[_e]),default:n(()=>[t(s(d),{selectionMode:"multiple",headerStyle:"width: 3em"}),t(s(d),{field:"modulo",header:"Módulo",sortable:!0,style:{"min-width":"10rem"}}),t(s(d),{field:"nombre_usuario",header:"Usuario",sortable:!0,style:{"min-width":"12rem"}},{body:n(({data:e})=>[h(u(e.nombre_usuario||"N/A (Global o Escuela)"),1)]),_:1}),t(s(d),{field:"id_escuela",header:"ID Escuela",sortable:!0,style:{width:"8rem"}}),t(s(d),{header:"Vigencia",style:{"min-width":"12rem"}},{body:n(({data:e})=>[i("div",fe,[pe,h(" "+u(A(e.fecha_inicio)),1)]),i("div",ve,[he,h(" "+u(A(e.fecha_fin)),1)])]),_:1}),t(s(d),{header:"Tiempo Restante",style:{"min-width":"10rem"}},{body:n(({data:e})=>[t(s(ae),{severity:G(e),value:j(e)},null,8,["severity","value"])]),_:1}),t(s(d),{header:"Estado",style:{width:"6rem"}},{body:n(({data:e})=>[t(s(T),{modelValue:e.estado,"onUpdate:modelValue":r=>e.estado=r,onChange:r=>P(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(s(d),{header:"Acciones",headerStyle:"width: 5em; text-align: center"},{body:n(({data:e})=>[t(s(_),{icon:"pi pi-pencil",class:"p-button-rounded p-button-info",onClick:r=>B(e)},null,8,["onClick"])]),_:1})]),_:1},8,["value","selection","loading","rows","totalRecords"])]),_:1})]),t(s(oe),{visible:b.value,"onUpdate:visible":a[10]||(a[10]=e=>b.value=e),modal:"",header:"Editar Regla",style:{width:"30rem"}},{footer:n(()=>[t(s(_),{label:"Cancelar",severity:"secondary",onClick:a[9]||(a[9]=e=>b.value=!1)}),t(s(_),{label:"Guardar Cambios",onClick:z,loading:p.value},null,8,["loading"])]),default:n(()=>[l.value?(g(),w("div",be,[i("div",null,[h("Módulo: "),i("strong",null,u(l.value.modulo),1)]),l.value.nombre_usuario?(g(),w("div",ge,[h("Usuario: "),i("strong",null,u(l.value.nombre_usuario),1)])):x("",!0),l.value.id_escuela?(g(),w("div",ye,[h("Escuela ID: "),i("strong",null,u(l.value.id_escuela),1)])):x("",!0),t(s(ne)),i("div",null,[we,t(s(I),{modelValue:l.value.fecha_inicio,"onUpdate:modelValue":a[6]||(a[6]=e=>l.value.fecha_inicio=e),showTime:"",hourFormat:"24",class:"w-full"},null,8,["modelValue"])]),i("div",null,[xe,t(s(I),{modelValue:l.value.fecha_fin,"onUpdate:modelValue":a[7]||(a[7]=e=>l.value.fecha_fin=e),showTime:"",hourFormat:"24",class:"w-full"},null,8,["modelValue"])]),i("div",Ve,[t(s(T),{modelValue:l.value.estado,"onUpdate:modelValue":a[8]||(a[8]=e=>l.value.estado=e)},null,8,["modelValue"]),i("label",$e,"Estado "+u(l.value.estado?"Activo":"Inactivo"),1)])])):x("",!0)]),_:1},8,["visible"])]),_:1}))}};export{je as default};
